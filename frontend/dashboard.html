<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stat Management - Uma Racing Web</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .navbar-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .user-info {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h2 {
            color: #2c3e50;
            font-size: 28px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.3s;
        }

        .card:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .stat-badge {
            background: #e8f4f8;
            color: #0084d4;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 13px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 13px;
            font-family: inherit;
        }

        input[type="number"]:focus,
        select:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .stat-input-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-input {
            display: flex;
            flex-direction: column;
        }

        .stat-input label {
            margin-bottom: 3px;
            font-size: 12px;
        }

        .stat-input input {
            padding: 8px;
            font-size: 12px;
        }

        .stat-total {
            background: #f5f7fa;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            margin: 10px 0;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .history-table th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .history-table tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-valid {
            background: #d4edda;
            color: #155724;
        }

        .status-invalid {
            background: #f8d7da;
            color: #721c24;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .success.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }

        .role-restricted {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üèá Uma Racing Web</h1>
        <div class="navbar-right">
            <div class="user-info">
                <span id="userDisplay"></span>
            </div>
            <button class="logout-btn" onclick="location.href='/main-menu.html'" style="background: #3498db;">Main Menu</button>
            <button class="logout-btn" onclick="location.href='/umalinkedin.html'">UmalinkedIn</button>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h2>Stat Management</h2>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('submit')">Submit Stats</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('trainees')">Trainees</button>
        </div>

        <!-- Submit Stats Tab -->
        <div id="submit" class="tab-content active">
            <div id="submitError" class="error"></div>
            <div id="submitSuccess" class="success"></div>

            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Submit Stats</div>
                    </div>

                    <div id="roleWarning" class="role-restricted" style="display: none;">
                        As a trainer, you can submit stats for your trainees. Select a trainee below.
                    </div>

                    <form id="statForm">
                        <div class="form-group" id="traineeSelect" style="display: none;">
                            <label for="selectTrainee">Select Trainee</label>
                            <select id="selectTrainee" name="trainee_id" required>
                                <option value="">Choose a trainee...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Speed (0-9999)</label>
                            <input type="number" name="speed" min="0" max="9999" required placeholder="0">
                        </div>

                        <div class="form-group">
                            <label>Stamina (0-9999)</label>
                            <input type="number" name="stamina" min="0" max="9999" required placeholder="0">
                        </div>

                        <div class="form-group">
                            <label>Power (0-9999)</label>
                            <input type="number" name="power" min="0" max="9999" required placeholder="0">
                        </div>

                        <div class="form-group">
                            <label>Guts (0-9999)</label>
                            <input type="number" name="guts" min="0" max="9999" required placeholder="0">
                        </div>

                        <div class="form-group">
                            <label>Wit (0-9999)</label>
                            <input type="number" name="wit" min="0" max="9999" required placeholder="0">
                        </div>

                        <div class="stat-total">
                            <span>Total:</span>
                            <strong id="totalStat">0</strong>
                        </div>

                        <button type="submit" class="submit-btn">Submit Stats</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div id="historyError" class="error"></div>

            <div id="historyTable" class="empty-state">
                <h3>Loading history...</h3>
            </div>
        </div>

        <!-- Trainees Tab -->
        <div id="trainees" class="tab-content">
            <div id="traineesGrid" class="grid"></div>
        </div>
    </div>

    <script>
        // API_BASE is defined in api-config.js
        let authToken = localStorage.getItem("access_token");
        let userRole = localStorage.getItem("user_role");
        let username = localStorage.getItem("username");

        if (!authToken) {
            window.location.href = "login.html";
        }

        document.getElementById("userDisplay").textContent = `${username} (${userRole})`;

        // Show role warning for trainers
        if (userRole === "trainer") {
            document.getElementById("roleWarning").style.display = "block";
            document.getElementById("traineeSelect").style.display = "block";
            loadTrainees();
        }

        // Load stat history
        async function loadHistory() {
            const historyDiv = document.getElementById("historyTable");
            try {
                const response = await fetch(`${API_BASE}/stats/history`, {
                    headers: {
                        "Authorization": `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.length === 0) {
                        historyDiv.innerHTML = "<h3>No stat submissions yet</h3>";
                        return;
                    }

                    let html = `
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Speed</th>
                                    <th>Stamina</th>
                                    <th>Power</th>
                                    <th>Guts</th>
                                    <th>Wit</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.forEach(entry => {
                        const date = new Date(entry.submitted_at).toLocaleDateString();
                        const total = entry.speed + entry.stamina + entry.power + entry.guts + entry.wit;
                        html += `
                            <tr>
                                <td>${date}</td>
                                <td>${entry.speed}</td>
                                <td>${entry.stamina}</td>
                                <td>${entry.power}</td>
                                <td>${entry.guts}</td>
                                <td>${entry.wit}</td>
                                <td><strong>${total}</strong></td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table>`;
                    historyDiv.innerHTML = html;
                }
            } catch (error) {
                historyDiv.innerHTML = "<h3>Error loading history</h3>";
            }
        }

        // Load trainees
        async function loadTrainees() {
            const grid = document.getElementById("traineesGrid");
            try {
                const response = await fetch(`${API_BASE}/trainees/my`, {
                    headers: {
                        "Authorization": `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.length === 0) {
                        grid.innerHTML = "<div class='empty-state'><h3>No trainees yet</h3></div>";
                        return;
                    }

                    // Populate trainer's trainee selector
                    if (userRole === "trainer") {
                        const select = document.getElementById("selectTrainee");
                        data.forEach(trainee => {
                            const option = document.createElement("option");
                            option.value = trainee.id;
                            option.textContent = trainee.name;
                            select.appendChild(option);
                        });
                    }

                    // Display trainee cards
                    grid.innerHTML = data.map(trainee => `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">${trainee.name}</div>
                                <span class="stat-badge">Trainee</span>
                            </div>
                            <p style="color: #666; margin-bottom: 10px; font-size: 13px;">${trainee.bio || 'No bio'}</p>
                            <p style="font-size: 12px; color: #999;">ID: ${trainee.id}</p>
                        </div>
                    `).join("");
                }
            } catch (error) {
                grid.innerHTML = "<div class='empty-state'><h3>Error loading trainees</h3></div>";
            }
        }

        // Form submission
        document.getElementById("statForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const errorDiv = document.getElementById("submitError");
            const successDiv = document.getElementById("submitSuccess");
            errorDiv.classList.remove("show");
            successDiv.classList.remove("show");

            const speed = parseInt(document.querySelector("input[name='speed']").value);
            const stamina = parseInt(document.querySelector("input[name='stamina']").value);
            const power = parseInt(document.querySelector("input[name='power']").value);
            const guts = parseInt(document.querySelector("input[name='guts']").value);
            const wit = parseInt(document.querySelector("input[name='wit']").value);

            let traineeId = null;
            if (userRole === "trainer") {
                traineeId = document.getElementById("selectTrainee").value;
                if (!traineeId) {
                    errorDiv.textContent = "Please select a trainee";
                    errorDiv.classList.add("show");
                    return;
                }
            }

            try {
                const response = await fetch(`${API_BASE}/stats/submit`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${authToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        trainee_id: traineeId,
                        speed,
                        stamina,
                        power,
                        guts,
                        wit
                    })
                });

                if (response.ok) {
                    successDiv.textContent = "‚úì Stats submitted successfully!";
                    successDiv.classList.add("show");
                    document.getElementById("statForm").reset();
                    document.getElementById("totalStat").textContent = "0";
                    setTimeout(loadHistory, 500);
                } else {
                    const data = await response.json();
                    errorDiv.textContent = data.detail || "Error submitting stats";
                    errorDiv.classList.add("show");
                }
            } catch (error) {
                errorDiv.textContent = "Connection error";
                errorDiv.classList.add("show");
            }
        });

        // Calculate total stats in real-time
        document.querySelectorAll("input[type='number']").forEach(input => {
            input.addEventListener("input", () => {
                const speed = parseInt(document.querySelector("input[name='speed']").value) || 0;
                const stamina = parseInt(document.querySelector("input[name='stamina']").value) || 0;
                const power = parseInt(document.querySelector("input[name='power']").value) || 0;
                const guts = parseInt(document.querySelector("input[name='guts']").value) || 0;
                const wit = parseInt(document.querySelector("input[name='wit']").value) || 0;
                const total = speed + stamina + power + guts + wit;
                document.getElementById("totalStat").textContent = total;
            });
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
            document.getElementById(tabName).classList.add("active");
            event.target.classList.add("active");

            if (tabName === "history") {
                loadHistory();
            } else if (tabName === "trainees") {
                loadTrainees();
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("user_role");
            localStorage.removeItem("username");
            window.location.href = "login.html";
        }

        // Load initial data
        loadHistory();
        if (userRole !== "trainer") {
            loadTrainees();
        }
    </script>
</body>
</html>
